<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Torc: torcmuxer.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Torc
   &#160;<span id="projectnumber">0.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../dir_19e1fafdf157c27762559b97f5d6a2d3.html">torc</a></li><li class="navelem"><a class="el" href="../../dir_9c2a3d5da268f161b4c43c665e50a044.html">ffmpeg</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">torcmuxer.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d3/d5e/torcmuxer_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/* Class TorcMuxer</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">*</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">* This file is part of the Torc project.</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">*</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">* Copyright (C) Mark Kendall 2018</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">*</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">* This program is free software; you can redistribute it and/or modify</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">* it under the terms of the GNU General Public License as published by</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">* the Free Software Foundation; either version 2 of the License, or</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">* (at your option) any later version.</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">*</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">* This program is distributed in the hope that it will be useful,</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">* but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">* GNU General Public License for more details.</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">*</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">* You should have received a copy of the GNU General Public License</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">* along with this program; if not, write to the Free Software</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">* Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301,</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">* USA.</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">// Qt</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &lt;QMutex&gt;</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &lt;QString&gt;</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">// Torc</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d4/df9/torclogging_8h.html">torclogging.h</a>&quot;</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d4/d0f/torcmuxer_8h.html">torcmuxer.h</a>&quot;</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">// FFmpeg</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> {</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#include &lt;libavcodec/avcodec.h&gt;</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;}</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno"><a class="line" href="../../d3/d5e/torcmuxer_8cpp.html#a0643743717c68ae8cb01fd198a71d3df">   36</a></span>&#160;<span class="preprocessor">#define FFMPEG_BUFFER_SIZE 64*1024</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div><div class="line"><a name="l00038"></a><span class="lineno"><a class="line" href="../../d3/d5e/torcmuxer_8cpp.html#a77d96363d23940699a2e28aa1c270730">   38</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d5e/torcmuxer_8cpp.html#a77d96363d23940699a2e28aa1c270730">TorcAVLog</a>(<span class="keywordtype">void</span> *Ptr, <span class="keywordtype">int</span> Level, <span class="keyword">const</span> <span class="keywordtype">char</span> *Fmt, va_list VAL)</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;{</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d4/df9/torclogging_8h.html#aeeb5ccc7d7c2bdc0591f5cdb1cc360be">VERBOSE_LEVEL_NONE</a>)</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    <span class="keyword">static</span> QString   line(<span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> length = 255;</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <span class="keyword">static</span> QMutex    lock;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    uint64_t         verboseMask  = VB_GENERAL;</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="keywordtype">int</span>              verboseLevel = LOG_DEBUG;</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    <span class="keywordflow">switch</span> (Level)</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    {</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;        <span class="keywordflow">case</span> AV_LOG_PANIC:</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;            verboseLevel = LOG_EMERG;</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;        <span class="keywordflow">case</span> AV_LOG_FATAL:</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;            verboseLevel = LOG_CRIT;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;        <span class="keywordflow">case</span> AV_LOG_ERROR:</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;            verboseLevel = LOG_ERR;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        <span class="keywordflow">case</span> AV_LOG_DEBUG:</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        <span class="keywordflow">case</span> AV_LOG_VERBOSE:</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;            verboseLevel = LOG_DEBUG;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;        <span class="keywordflow">case</span> AV_LOG_INFO:</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;            verboseLevel = LOG_INFO;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        <span class="keywordflow">case</span> AV_LOG_WARNING:</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;            verboseLevel = LOG_WARNING;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    }</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../d4/df9/torclogging_8h.html#aa2c2cf7786c2730b3b739536b797f132">VERBOSE_LEVEL_CHECK</a>(verboseMask, verboseLevel))</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    lock.lock();</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="keywordflow">if</span> (line.isEmpty() &amp;&amp; Ptr) {</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;        AVClass* avc = *(AVClass**)Ptr;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        line.sprintf(<span class="stringliteral">&quot;[%s @ %p] &quot;</span>, avc-&gt;item_name(Ptr), avc);</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    }</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <span class="keywordtype">char</span> str[length+1];</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <span class="keywordtype">int</span> bytes = vsnprintf(str, length+1, Fmt, VAL);</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    <span class="comment">// check for truncated messages and fix them</span></div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="keywordflow">if</span> (bytes &gt; length)</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    {</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;        <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_WARNING,</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;            QString(<span class="stringliteral">&quot;Libav log output truncated %1 of %2 bytes written&quot;</span>)</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;                .arg(length).arg(bytes));</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        str[length - 1] = <span class="charliteral">&#39;\n&#39;</span>;</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    }</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    line += QString(str);</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    <span class="keywordflow">if</span> (line.endsWith(<span class="stringliteral">&quot;\n&quot;</span>))</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    {</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(verboseMask, verboseLevel, line.trimmed());</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        line.truncate(0);</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    }</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    lock.unlock();</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;}</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div><div class="line"><a name="l00104"></a><span class="lineno"><a class="line" href="../../d2/d10/class_torc_muxer.html#aabbe34739f37106e63b57ed97f2c3c9f">  104</a></span>&#160;<a class="code" href="../../d2/d10/class_torc_muxer.html#a746b46ae977e740e490787efe764116f">TorcMuxer::TorcMuxer</a>(<a class="code" href="../../df/d16/class_torc_segmented_ring_buffer.html">TorcSegmentedRingBuffer</a> *Buffer)</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;  : m_formatCtx(NULL),</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    m_created(<a class="code" href="../../d1/d37/torcloggingdefs_8h.html#a93519f65dd0ef21fc5be0c286a833ae4">false</a>),</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    m_started(<a class="code" href="../../d1/d37/torcloggingdefs_8h.html#a93519f65dd0ef21fc5be0c286a833ae4">false</a>),</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    m_outputFile(),</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    m_ringBuffer(Buffer),</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    m_ioContext(NULL),</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    m_audioContext(NULL),</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    m_audioStream(0),</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    m_audioFrame(NULL),</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    m_audioPacket(NULL),</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    m_lastVideoPts(AV_NOPTS_VALUE),</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    m_lastAudioPts(AV_NOPTS_VALUE)</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;{</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    av_log_set_callback(<a class="code" href="../../d3/d5e/torcmuxer_8cpp.html#a77d96363d23940699a2e28aa1c270730">TorcAVLog</a>);</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    SetupContext();</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    SetupIO();</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;}</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;</div><div class="line"><a name="l00123"></a><span class="lineno"><a class="line" href="../../d2/d10/class_torc_muxer.html#a746b46ae977e740e490787efe764116f">  123</a></span>&#160;<a class="code" href="../../d2/d10/class_torc_muxer.html#a746b46ae977e740e490787efe764116f">TorcMuxer::TorcMuxer</a>(<span class="keyword">const</span> QString &amp;File)</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  : m_formatCtx(NULL),</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    m_created(<a class="code" href="../../d1/d37/torcloggingdefs_8h.html#a93519f65dd0ef21fc5be0c286a833ae4">false</a>),</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    m_started(<a class="code" href="../../d1/d37/torcloggingdefs_8h.html#a93519f65dd0ef21fc5be0c286a833ae4">false</a>),</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    m_outputFile(File),</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    m_ringBuffer(NULL),</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    m_ioContext(NULL),</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    m_audioContext(NULL),</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    m_audioStream(0),</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    m_audioFrame(NULL),</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    m_audioPacket(NULL),</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    m_lastVideoPts(AV_NOPTS_VALUE),</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    m_lastAudioPts(AV_NOPTS_VALUE)</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;{</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    SetupContext();</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    SetupIO();</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;}</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div><div class="line"><a name="l00141"></a><span class="lineno"><a class="line" href="../../d2/d10/class_torc_muxer.html#a6ba554a88a936b2a9719377112648d89">  141</a></span>&#160;<a class="code" href="../../d2/d10/class_torc_muxer.html#a6ba554a88a936b2a9719377112648d89">TorcMuxer::~TorcMuxer</a>()</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;{</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <span class="comment">// TODO check whether this is safe with file output</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="keywordflow">if</span> (m_ioContext)</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    {</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        <span class="keywordflow">if</span> (m_ioContext-&gt;buffer)</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        {</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;            av_free(m_ioContext-&gt;buffer);</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;            m_ioContext-&gt;buffer = NULL;</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        }</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        av_free(m_ioContext);</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        m_ioContext = NULL;</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    }</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <span class="keywordflow">if</span> (m_formatCtx)</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    {</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        avformat_free_context(m_formatCtx);</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        m_formatCtx = NULL;</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    }</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    <span class="keywordflow">if</span> (m_audioFrame)</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    {</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        av_frame_free(&amp;m_audioFrame);</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        m_audioFrame = NULL;</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    }</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    <span class="keywordflow">if</span> (m_audioPacket)</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    {</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        av_packet_free(&amp;m_audioPacket);</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        m_audioPacket = NULL;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    }</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="keywordflow">if</span> (m_audioContext)</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    {</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        avcodec_free_context(&amp;m_audioContext);</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        m_audioContext = NULL;</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    }</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;}</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="keywordtype">void</span> TorcMuxer::SetupContext(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;{</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <span class="comment">// TODO can this be called once</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    av_register_all();</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    AVOutputFormat *format = av_guess_format(<span class="stringliteral">&quot;mp4&quot;</span>, NULL, NULL);</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    <span class="keywordflow">if</span> (!format)</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    {</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_ERR, <span class="stringliteral">&quot;Failed to find MPEGTS muxer&quot;</span>);</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    }</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <span class="comment">// create context</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    m_formatCtx = avformat_alloc_context();</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="keywordflow">if</span> (!m_formatCtx)</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    {</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_ERR, <span class="stringliteral">&quot;Failed to create AVFormatContext&quot;</span>);</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    }</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    m_formatCtx-&gt;oformat = format;</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;}</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="keywordtype">void</span> TorcMuxer::SetupIO(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;{</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="keywordflow">if</span> (!m_formatCtx)</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    <span class="keywordflow">if</span> (!m_outputFile.isEmpty())</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    {</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        <span class="comment">// create output file</span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        <span class="keywordflow">if</span> (avio_open(&amp;m_formatCtx-&gt;pb, m_outputFile.toLocal8Bit().constData(), AVIO_FLAG_WRITE) &lt; 0)</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        {</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;            <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_ERR, QString(<span class="stringliteral">&quot;Failed to open &#39;%1&#39; for output&quot;</span>).arg(m_outputFile));</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;        }</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        m_created = <span class="keyword">true</span>;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    }</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="keywordflow">if</span> (m_ringBuffer)</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    {</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        uint8_t* iobuffer  = (uint8_t *)av_malloc(<a class="code" href="../../d3/d5e/torcmuxer_8cpp.html#a0643743717c68ae8cb01fd198a71d3df">FFMPEG_BUFFER_SIZE</a>);</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        m_ioContext        = avio_alloc_context(iobuffer, <a class="code" href="../../d3/d5e/torcmuxer_8cpp.html#a0643743717c68ae8cb01fd198a71d3df">FFMPEG_BUFFER_SIZE</a>, 1, <span class="keyword">this</span>, NULL, &amp;<a class="code" href="../../d2/d10/class_torc_muxer.html#a5a06636f80d0630bf57c27c2a67d7bdb">AVWritePacket</a>, NULL);</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        m_formatCtx-&gt;pb    = m_ioContext;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        m_formatCtx-&gt;flags = AVFMT_FLAG_CUSTOM_IO;</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        m_created = <span class="keyword">true</span>;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    }</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;}</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div><div class="line"><a name="l00230"></a><span class="lineno"><a class="line" href="../../d2/d10/class_torc_muxer.html#a5a06636f80d0630bf57c27c2a67d7bdb">  230</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d2/d10/class_torc_muxer.html#a5a06636f80d0630bf57c27c2a67d7bdb">TorcMuxer::AVWritePacket</a>(<span class="keywordtype">void</span> *Opaque, uint8_t *Buffer, <span class="keywordtype">int</span> Size)</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;{</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <a class="code" href="../../d2/d10/class_torc_muxer.html">TorcMuxer</a>* muxer = <span class="keyword">static_cast&lt;</span><a class="code" href="../../d2/d10/class_torc_muxer.html">TorcMuxer</a>*<span class="keyword">&gt;</span>(Opaque);</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="keywordflow">if</span> (!muxer)</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="keywordflow">return</span> muxer-&gt;<a class="code" href="../../d2/d10/class_torc_muxer.html#ae997004c110ecc7e806e3e3f3a5147a3">WriteAVPacket</a>(Buffer, Size);</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;}</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;</div><div class="line"><a name="l00244"></a><span class="lineno"><a class="line" href="../../d2/d10/class_torc_muxer.html#aecf0fd0c533cc4e6690982c4354c1839">  244</a></span>&#160;QString <a class="code" href="../../d2/d10/class_torc_muxer.html#aecf0fd0c533cc4e6690982c4354c1839">TorcMuxer::GetAVCCodec</a>(<span class="keyword">const</span> QByteArray &amp;Packet)</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;{</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    <span class="keywordtype">int</span> size = Packet.size();</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <span class="keywordflow">if</span> (size &lt; 7) <span class="comment">// 3 (or 4) byte start code, 1 byte NALU, 1 byte IDC, 1 byte constraints and 1 byte level</span></div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    {</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_WARNING, <span class="stringliteral">&quot;Cannot retrieve AVC1 codec data from packet - too short&quot;</span>);</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        <span class="keywordflow">return</span> QString();</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    }</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    <span class="keywordtype">int</span> index = 0;</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    <span class="keywordflow">for</span> (; index &lt; 2; index++)</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    {</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        <span class="keywordflow">if</span> (Packet[index] == 0 &amp;&amp; Packet[index + 1] == 0 &amp;&amp; Packet[index + 2] == 1)</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        {</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;            found = <span class="keyword">true</span>;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        }</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    }</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="keywordflow">if</span> (!found)</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    {</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;        <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_WARNING, <span class="stringliteral">&quot;Failed to find start code&quot;</span>);</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        <span class="keywordflow">return</span> QString();</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    }</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    index += 3;</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    <span class="keywordflow">if</span> ((Packet[index] &amp; 0x1f) == 7) <span class="comment">// SPS NAL UNIT</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;        <span class="keywordflow">return</span> QString(<span class="stringliteral">&quot;avc1.%1%2%3&quot;</span>).arg(Packet[index + 1], 2, 16, QChar(<span class="charliteral">&#39;0&#39;</span>)).arg(Packet[index + 2], 2, 16, QChar(<span class="charliteral">&#39;0&#39;</span>)).arg(Packet[index + 3], 2, 16, QChar(<span class="charliteral">&#39;0&#39;</span>));</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_WARNING, <span class="stringliteral">&quot;Failed to find SPS&quot;</span>);</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <span class="keywordflow">return</span> QString();</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;}</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;</div><div class="line"><a name="l00278"></a><span class="lineno"><a class="line" href="../../d2/d10/class_torc_muxer.html#ae997004c110ecc7e806e3e3f3a5147a3">  278</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d2/d10/class_torc_muxer.html#ae997004c110ecc7e806e3e3f3a5147a3">TorcMuxer::WriteAVPacket</a>(uint8_t *Buffer, <span class="keywordtype">int</span> Size)</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;{</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    <span class="keywordflow">if</span> (!Buffer || Size &lt; 1)</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <span class="keywordflow">if</span> (m_ringBuffer)</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        <span class="keywordflow">return</span> m_ringBuffer-&gt;<a class="code" href="../../df/d16/class_torc_segmented_ring_buffer.html#adbc0e06eba5dabc6be2c21fae81f4fc9">Write</a>(Buffer, Size);</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;}</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;</div><div class="line"><a name="l00289"></a><span class="lineno"><a class="line" href="../../d2/d10/class_torc_muxer.html#ad65e6a2093484ae56551795e47c8ecd6">  289</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../d2/d10/class_torc_muxer.html#ad65e6a2093484ae56551795e47c8ecd6">TorcMuxer::IsValid</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;{</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    <span class="keywordflow">return</span> m_formatCtx &amp;&amp; m_formatCtx-&gt;nb_streams &gt; 0 &amp;&amp; m_created;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;}</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;</div><div class="line"><a name="l00294"></a><span class="lineno"><a class="line" href="../../d2/d10/class_torc_muxer.html#aefaea1947034770137137827f37f5089">  294</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d2/d10/class_torc_muxer.html#aefaea1947034770137137827f37f5089">TorcMuxer::AddDummyAudioStream</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;{</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    <span class="keywordflow">if</span> (!m_formatCtx)</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    AVStream *audiostream = avformat_new_stream(m_formatCtx, 0);</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <span class="keywordflow">if</span> (!audiostream)</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;    m_audioStream                         = m_formatCtx-&gt;nb_streams - 1;</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    audiostream-&gt;id                       = m_formatCtx-&gt;nb_streams - 1;</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    audiostream-&gt;codecpar-&gt;codec_id       = AV_CODEC_ID_AAC;</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    audiostream-&gt;codecpar-&gt;codec_type     = AVMEDIA_TYPE_AUDIO;</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    audiostream-&gt;codecpar-&gt;codec_tag      = 0;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    audiostream-&gt;codecpar-&gt;bit_rate       = 64000;</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    audiostream-&gt;codecpar-&gt;sample_rate    = 44100;</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    audiostream-&gt;codecpar-&gt;channels       = 2;</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    audiostream-&gt;codecpar-&gt;channel_layout = AV_CH_LAYOUT_STEREO;</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_INFO, QString(<span class="stringliteral">&quot;Audio stream id %1&quot;</span>).arg(audiostream-&gt;id));</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    AVCodec* codec = avcodec_find_encoder(audiostream-&gt;codecpar-&gt;codec_id);</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    <span class="keywordflow">if</span> (!codec)</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    {</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_ERR, <span class="stringliteral">&quot;Failed to find dummy audio codec&quot;</span>);</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    }</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_INFO, QString(<span class="stringliteral">&quot;Found audio codec &#39;%1&#39;&quot;</span>).arg(codec-&gt;name));</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    m_audioContext = avcodec_alloc_context3(codec);</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    <span class="keywordflow">if</span> (!m_audioContext)</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    {</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_ERR, <span class="stringliteral">&quot;Failed to create audio context&quot;</span>);</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    }</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_INFO, <span class="stringliteral">&quot;Created audio context&quot;</span>);</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    avcodec_parameters_to_context(m_audioContext, audiostream-&gt;codecpar);</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    m_audioContext-&gt;sample_fmt = AV_SAMPLE_FMT_FLTP;</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    <span class="keywordflow">if</span> (m_formatCtx-&gt;oformat-&gt;flags &amp; AVFMT_GLOBALHEADER)</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        m_audioContext-&gt;flags |= AV_CODEC_FLAG_GLOBAL_HEADER;</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    <span class="keywordflow">if</span> (avcodec_open2(m_audioContext, codec, NULL) &lt; 0)</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    {</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_ERR, QString(<span class="stringliteral">&quot;Failed to open codec &#39;%1&#39;&quot;</span>).arg(codec-&gt;name));</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    }</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_INFO, QString(<span class="stringliteral">&quot;Dummy audio: frame size %1 sample_fmt %2 sample_rate %3 bitrate %4 channels %5&quot;</span>)</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;        .arg(m_audioContext-&gt;frame_size).arg(m_audioContext-&gt;sample_fmt).arg(m_audioContext-&gt;sample_rate)</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        .arg(m_audioContext-&gt;bit_rate).arg(m_audioContext-&gt;channels));</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    m_audioPacket                = av_packet_alloc();</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    m_audioFrame                 = av_frame_alloc();</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    m_audioFrame-&gt;nb_samples     = m_audioContext-&gt;frame_size;</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    m_audioFrame-&gt;format         = m_audioContext-&gt;sample_fmt;</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    m_audioFrame-&gt;channel_layout = m_audioContext-&gt;channel_layout;</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    CopyExtraData(m_audioContext-&gt;extradata_size, m_audioContext-&gt;extradata, m_audioStream);</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    <span class="keywordflow">if</span> (av_frame_get_buffer(m_audioFrame, 0) &lt; 0)</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    {</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;        <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_ERR, <span class="stringliteral">&quot;Failed to create audio frame buffers&quot;</span>);</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    }</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="keywordflow">return</span> audiostream-&gt;id;</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;}</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="keywordtype">void</span> TorcMuxer::WriteDummyAudio(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;{</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;    <span class="keywordflow">if</span> (!m_audioContext || !m_audioFrame || !m_audioPacket || m_lastVideoPts == AV_NOPTS_VALUE || !m_formatCtx)</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    <span class="keywordflow">while</span> (1)</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    {</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        <span class="keywordflow">if</span> (avcodec_send_frame(m_audioContext, m_audioFrame) &lt; 0)</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;        {</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;            <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_ERR, <span class="stringliteral">&quot;Error sending frame to audio encoder&quot;</span>);</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        }</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        {</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;            <span class="keywordtype">int</span> rec = avcodec_receive_packet(m_audioContext, m_audioPacket);</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;            <span class="keywordflow">if</span> (rec == AVERROR(EAGAIN))</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;            <span class="keywordflow">if</span> (rec &lt; 0)</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;            {</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_ERR, <span class="stringliteral">&quot;Error receiving packet from audio encoder&quot;</span>);</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;            }</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;            <span class="keywordflow">while</span> ((m_lastVideoPts &gt; m_lastAudioPts) || m_lastAudioPts == AV_NOPTS_VALUE)</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;            {</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;                int64_t duration = ((float)m_audioContext-&gt;frame_size / 44100.0) * 90000;</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                m_lastAudioPts = m_lastAudioPts == AV_NOPTS_VALUE ? m_lastVideoPts : m_lastAudioPts + duration;</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;                m_audioPacket-&gt;pts = m_lastAudioPts;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                m_audioPacket-&gt;dts = m_lastAudioPts;</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;                m_audioPacket-&gt;stream_index = m_audioStream;</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;                <span class="keywordflow">if</span> (av_write_frame(m_formatCtx, m_audioPacket) &lt; 0)</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;                    <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_ERR, <span class="stringliteral">&quot;Failed to write audio frame to muxer&quot;</span>);</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;            }</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;            av_packet_unref(m_audioPacket);</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;        }</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    }</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;}</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;</div><div class="line"><a name="l00396"></a><span class="lineno"><a class="line" href="../../d2/d10/class_torc_muxer.html#a7e8da7650eb8700e03acbc2dde638acf">  396</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d2/d10/class_torc_muxer.html#a7e8da7650eb8700e03acbc2dde638acf">TorcMuxer::AddH264Stream</a>(<span class="keywordtype">int</span> Width, <span class="keywordtype">int</span> Height, <span class="keywordtype">int</span> Profile, <span class="keywordtype">int</span> Bitrate)</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;{</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    <span class="keywordflow">if</span> (!m_formatCtx)</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;    AVStream *h264video = avformat_new_stream(m_formatCtx, 0);</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    <span class="keywordflow">if</span> (!h264video)</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    h264video-&gt;id = m_formatCtx-&gt;nb_streams - 1;</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    h264video-&gt;codecpar-&gt;codec_id            = AV_CODEC_ID_H264;</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    h264video-&gt;codecpar-&gt;codec_type          = AVMEDIA_TYPE_VIDEO;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    h264video-&gt;codecpar-&gt;codec_tag           = 0;</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    h264video-&gt;codecpar-&gt;bit_rate            = Bitrate;</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    h264video-&gt;codecpar-&gt;profile             = Profile;</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    h264video-&gt;codecpar-&gt;level               = 30; <span class="comment">// does this need to be set properly?</span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    h264video-&gt;codecpar-&gt;format              = AV_PIX_FMT_YUV420P;</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    h264video-&gt;codecpar-&gt;width               = Width;</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    h264video-&gt;codecpar-&gt;height              = Height;</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    <span class="keywordflow">return</span> h264video-&gt;id;</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;}</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;<span class="keywordtype">void</span> TorcMuxer::CopyExtraData(<span class="keywordtype">int</span> Size, <span class="keywordtype">void</span>* Source, <span class="keywordtype">int</span> Stream)</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;{</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    <span class="keywordflow">if</span> (!m_formatCtx || !Source || Size &lt; 1)</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    <span class="keywordflow">if</span> (m_formatCtx-&gt;nb_streams &lt;= 0 || (uint)Stream &gt;= m_formatCtx-&gt;nb_streams || Stream &lt; 0)</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    {</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_INFO, <span class="stringliteral">&quot;Cannot copy extradata - invalid stream&quot;</span>);</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    }</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    AVStream *stream = m_formatCtx-&gt;streams[Stream];</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    stream-&gt;codecpar-&gt;extradata = (uint8_t*)av_mallocz(Size + AV_INPUT_BUFFER_PADDING_SIZE);</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    stream-&gt;codecpar-&gt;extradata_size = Size;</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    memcpy(stream-&gt;codecpar-&gt;extradata, Source, Size);</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;}</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;</div><div class="line"><a name="l00435"></a><span class="lineno"><a class="line" href="../../d2/d10/class_torc_muxer.html#a14c2e7df6e41835fea3fdd9e3a823187">  435</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../d2/d10/class_torc_muxer.html#a14c2e7df6e41835fea3fdd9e3a823187">TorcMuxer::AddPacket</a>(AVPacket *Packet, <span class="keywordtype">bool</span> CodecConfig)</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;{</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    <span class="keywordflow">if</span> (!m_formatCtx || !m_created || !Packet)</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;    <span class="keywordflow">if</span> (CodecConfig)</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    {</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        CopyExtraData(Packet-&gt;size, Packet-&gt;data, Packet-&gt;stream_index);</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        <span class="comment">// and start muxer if needed</span></div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        <span class="keywordflow">if</span> (!m_started)</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        {</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;            Start();</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;            m_started = <span class="keyword">true</span>;</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        }</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    }</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    <span class="keywordflow">if</span> (!m_started)</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    {</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;        <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_WARNING, <span class="stringliteral">&quot;Ignoring packet - stream not started (waiting for config?)&quot;</span>);</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    }</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;    <span class="keywordtype">int</span> result = av_write_frame(m_formatCtx, Packet);</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;    <span class="keywordflow">if</span> (result &lt; 0)</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;        <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_ERR, <span class="stringliteral">&quot;Failed to write video frame&quot;</span>);</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;        m_lastVideoPts = Packet-&gt;pts;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;    WriteDummyAudio();</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    <span class="keywordflow">return</span> result &gt;= 0;</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;}</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;</div><div class="line"><a name="l00468"></a><span class="lineno"><a class="line" href="../../d2/d10/class_torc_muxer.html#a57ae0d84ebf94edb2484b06fd3a20db8">  468</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d2/d10/class_torc_muxer.html#a57ae0d84ebf94edb2484b06fd3a20db8">TorcMuxer::FinishSegment</a>(<span class="keywordtype">bool</span> Init)</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;{</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="keywordflow">if</span> (m_formatCtx)</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    {</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        av_write_frame(m_formatCtx, NULL);</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        <span class="keywordflow">if</span> (m_ringBuffer)</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;            m_ringBuffer-&gt;<a class="code" href="../../df/d16/class_torc_segmented_ring_buffer.html#ab5b2f20ec1485b9bc6ada028a4b419b8">FinishSegment</a>(Init);</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    }</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;}</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="keywordtype">void</span> TorcMuxer::Start(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;{</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <span class="keywordflow">if</span> (m_formatCtx)</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    {</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;        av_dump_format(m_formatCtx, 0, <span class="stringliteral">&quot;stdout&quot;</span>, 1);</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;        AVDictionary *opts = NULL;</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;        av_dict_set(&amp;opts, <span class="stringliteral">&quot;movflags&quot;</span>, <span class="stringliteral">&quot;frag_custom+dash+delay_moov&quot;</span>, 0);</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        <span class="keywordflow">if</span> (avformat_write_header(m_formatCtx, &amp;opts))</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;            <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_ERR, <span class="stringliteral">&quot;Failed to set demuxer options&quot;</span>);</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;        av_dict_free(&amp;opts);</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    }</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;}</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;</div><div class="line"><a name="l00491"></a><span class="lineno"><a class="line" href="../../d2/d10/class_torc_muxer.html#a950ba61b56c98d726f9ec1249252cc3e">  491</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d2/d10/class_torc_muxer.html#a950ba61b56c98d726f9ec1249252cc3e">TorcMuxer::Finish</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;{</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    <span class="keywordflow">if</span> (m_audioContext &amp;&amp; m_audioPacket)</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    {</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;        <span class="comment">// flush</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;        avcodec_send_frame(m_audioContext, NULL);</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;        <span class="keywordflow">while</span> (avcodec_receive_packet(m_audioContext, m_audioPacket) &gt;= 0)</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;            av_packet_unref(m_audioPacket);</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    }</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    <span class="keywordflow">if</span> (m_formatCtx)</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    {</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        <span class="keywordflow">if</span> (av_write_trailer(m_formatCtx))</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;            <a class="code" href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a>(VB_GENERAL, LOG_ERR, <span class="stringliteral">&quot;Failed to write stream trailer&quot;</span>);</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;        <span class="comment">//avio_close(m_formatCtx-&gt;pb);</span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    }</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;}</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;<span class="comment">/* vim: set expandtab tabstop=4 shiftwidth=4: */</span></div><div class="ttc" id="class_torc_muxer_html_a950ba61b56c98d726f9ec1249252cc3e"><div class="ttname"><a href="../../d2/d10/class_torc_muxer.html#a950ba61b56c98d726f9ec1249252cc3e">TorcMuxer::Finish</a></div><div class="ttdeci">void Finish(void)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d5e/torcmuxer_8cpp_source.html#l00491">torcmuxer.cpp:491</a></div></div>
<div class="ttc" id="class_torc_muxer_html_a7e8da7650eb8700e03acbc2dde638acf"><div class="ttname"><a href="../../d2/d10/class_torc_muxer.html#a7e8da7650eb8700e03acbc2dde638acf">TorcMuxer::AddH264Stream</a></div><div class="ttdeci">int AddH264Stream(int Width, int Height, int Profile, int Bitrate)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d5e/torcmuxer_8cpp_source.html#l00396">torcmuxer.cpp:396</a></div></div>
<div class="ttc" id="torcmuxer_8cpp_html_a0643743717c68ae8cb01fd198a71d3df"><div class="ttname"><a href="../../d3/d5e/torcmuxer_8cpp.html#a0643743717c68ae8cb01fd198a71d3df">FFMPEG_BUFFER_SIZE</a></div><div class="ttdeci">#define FFMPEG_BUFFER_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d5e/torcmuxer_8cpp_source.html#l00036">torcmuxer.cpp:36</a></div></div>
<div class="ttc" id="class_torc_muxer_html_aefaea1947034770137137827f37f5089"><div class="ttname"><a href="../../d2/d10/class_torc_muxer.html#aefaea1947034770137137827f37f5089">TorcMuxer::AddDummyAudioStream</a></div><div class="ttdeci">int AddDummyAudioStream(void)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d5e/torcmuxer_8cpp_source.html#l00294">torcmuxer.cpp:294</a></div></div>
<div class="ttc" id="class_torc_muxer_html_ad65e6a2093484ae56551795e47c8ecd6"><div class="ttname"><a href="../../d2/d10/class_torc_muxer.html#ad65e6a2093484ae56551795e47c8ecd6">TorcMuxer::IsValid</a></div><div class="ttdeci">bool IsValid(void)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d5e/torcmuxer_8cpp_source.html#l00289">torcmuxer.cpp:289</a></div></div>
<div class="ttc" id="class_torc_muxer_html_aecf0fd0c533cc4e6690982c4354c1839"><div class="ttname"><a href="../../d2/d10/class_torc_muxer.html#aecf0fd0c533cc4e6690982c4354c1839">TorcMuxer::GetAVCCodec</a></div><div class="ttdeci">static QString GetAVCCodec(const QByteArray &amp;Packet)</div><div class="ttdoc">Determine the 3 byte H.264 codec descriptor string. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d5e/torcmuxer_8cpp_source.html#l00244">torcmuxer.cpp:244</a></div></div>
<div class="ttc" id="class_torc_muxer_html_a14c2e7df6e41835fea3fdd9e3a823187"><div class="ttname"><a href="../../d2/d10/class_torc_muxer.html#a14c2e7df6e41835fea3fdd9e3a823187">TorcMuxer::AddPacket</a></div><div class="ttdeci">bool AddPacket(AVPacket *Packet, bool CodecConfig)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d5e/torcmuxer_8cpp_source.html#l00435">torcmuxer.cpp:435</a></div></div>
<div class="ttc" id="torclogging_8h_html"><div class="ttname"><a href="../../d4/df9/torclogging_8h.html">torclogging.h</a></div></div>
<div class="ttc" id="class_torc_muxer_html_a57ae0d84ebf94edb2484b06fd3a20db8"><div class="ttname"><a href="../../d2/d10/class_torc_muxer.html#a57ae0d84ebf94edb2484b06fd3a20db8">TorcMuxer::FinishSegment</a></div><div class="ttdeci">void FinishSegment(bool Init)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d5e/torcmuxer_8cpp_source.html#l00468">torcmuxer.cpp:468</a></div></div>
<div class="ttc" id="class_torc_segmented_ring_buffer_html_ab5b2f20ec1485b9bc6ada028a4b419b8"><div class="ttname"><a href="../../df/d16/class_torc_segmented_ring_buffer.html#ab5b2f20ec1485b9bc6ada028a4b419b8">TorcSegmentedRingBuffer::FinishSegment</a></div><div class="ttdeci">int FinishSegment(bool Init)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d3b/torcsegmentedringbuffer_8cpp_source.html#l00078">torcsegmentedringbuffer.cpp:78</a></div></div>
<div class="ttc" id="class_torc_muxer_html_a6ba554a88a936b2a9719377112648d89"><div class="ttname"><a href="../../d2/d10/class_torc_muxer.html#a6ba554a88a936b2a9719377112648d89">TorcMuxer::~TorcMuxer</a></div><div class="ttdeci">~TorcMuxer()</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d5e/torcmuxer_8cpp_source.html#l00141">torcmuxer.cpp:141</a></div></div>
<div class="ttc" id="class_torc_muxer_html_ae997004c110ecc7e806e3e3f3a5147a3"><div class="ttname"><a href="../../d2/d10/class_torc_muxer.html#ae997004c110ecc7e806e3e3f3a5147a3">TorcMuxer::WriteAVPacket</a></div><div class="ttdeci">int WriteAVPacket(uint8_t *Buffer, int Size)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d5e/torcmuxer_8cpp_source.html#l00278">torcmuxer.cpp:278</a></div></div>
<div class="ttc" id="class_torc_muxer_html_a5a06636f80d0630bf57c27c2a67d7bdb"><div class="ttname"><a href="../../d2/d10/class_torc_muxer.html#a5a06636f80d0630bf57c27c2a67d7bdb">TorcMuxer::AVWritePacket</a></div><div class="ttdeci">static int AVWritePacket(void *Opaque, uint8_t *Buffer, int Size)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d5e/torcmuxer_8cpp_source.html#l00230">torcmuxer.cpp:230</a></div></div>
<div class="ttc" id="torcloggingdefs_8h_html_a93519f65dd0ef21fc5be0c286a833ae4"><div class="ttname"><a href="../../d1/d37/torcloggingdefs_8h.html#a93519f65dd0ef21fc5be0c286a833ae4">false</a></div><div class="ttdeci">VERBOSE_PREAMBLE General info Playback related messages File and AutoExpire related messages Network protocol related messages Audio related messages JobQueue related messages EIT related messages DSMCC carousel related messages UPnP debugging messages xmltv output and related messages Media Manager debugging messages External executable related messages false</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d37/torcloggingdefs_8h_source.html#l00110">torcloggingdefs.h:110</a></div></div>
<div class="ttc" id="torclogging_8h_html_aeeb5ccc7d7c2bdc0591f5cdb1cc360be"><div class="ttname"><a href="../../d4/df9/torclogging_8h.html#aeeb5ccc7d7c2bdc0591f5cdb1cc360be">VERBOSE_LEVEL_NONE</a></div><div class="ttdeci">#define VERBOSE_LEVEL_NONE</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/df9/torclogging_8h_source.html#l00016">torclogging.h:16</a></div></div>
<div class="ttc" id="class_torc_muxer_html"><div class="ttname"><a href="../../d2/d10/class_torc_muxer.html">TorcMuxer</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d0f/torcmuxer_8h_source.html#l00015">torcmuxer.h:15</a></div></div>
<div class="ttc" id="class_torc_segmented_ring_buffer_html"><div class="ttname"><a href="../../df/d16/class_torc_segmented_ring_buffer.html">TorcSegmentedRingBuffer</a></div><div class="ttdef"><b>Definition:</b> <a href="../../de/df7/torcsegmentedringbuffer_8h_source.html#l00010">torcsegmentedringbuffer.h:10</a></div></div>
<div class="ttc" id="class_torc_segmented_ring_buffer_html_adbc0e06eba5dabc6be2c21fae81f4fc9"><div class="ttname"><a href="../../df/d16/class_torc_segmented_ring_buffer.html#adbc0e06eba5dabc6be2c21fae81f4fc9">TorcSegmentedRingBuffer::Write</a></div><div class="ttdeci">int Write(QByteArray *Data, int Size)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d3b/torcsegmentedringbuffer_8cpp_source.html#l00136">torcsegmentedringbuffer.cpp:136</a></div></div>
<div class="ttc" id="torcmuxer_8cpp_html_a77d96363d23940699a2e28aa1c270730"><div class="ttname"><a href="../../d3/d5e/torcmuxer_8cpp.html#a77d96363d23940699a2e28aa1c270730">TorcAVLog</a></div><div class="ttdeci">static void TorcAVLog(void *Ptr, int Level, const char *Fmt, va_list VAL)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d5e/torcmuxer_8cpp_source.html#l00038">torcmuxer.cpp:38</a></div></div>
<div class="ttc" id="class_torc_muxer_html_a746b46ae977e740e490787efe764116f"><div class="ttname"><a href="../../d2/d10/class_torc_muxer.html#a746b46ae977e740e490787efe764116f">TorcMuxer::TorcMuxer</a></div><div class="ttdeci">TorcMuxer(const QString &amp;File)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d5e/torcmuxer_8cpp_source.html#l00123">torcmuxer.cpp:123</a></div></div>
<div class="ttc" id="torclogging_8h_html_aa2c2cf7786c2730b3b739536b797f132"><div class="ttname"><a href="../../d4/df9/torclogging_8h.html#aa2c2cf7786c2730b3b739536b797f132">VERBOSE_LEVEL_CHECK</a></div><div class="ttdeci">#define VERBOSE_LEVEL_CHECK(_MASK_, _LEVEL_)</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/df9/torclogging_8h_source.html#l00017">torclogging.h:17</a></div></div>
<div class="ttc" id="torcmuxer_8h_html"><div class="ttname"><a href="../../d4/d0f/torcmuxer_8h.html">torcmuxer.h</a></div></div>
<div class="ttc" id="torclogging_8h_html_a73a147108bf0df6442820b82b022ef94"><div class="ttname"><a href="../../d4/df9/torclogging_8h.html#a73a147108bf0df6442820b82b022ef94">LOG</a></div><div class="ttdeci">#define LOG(_MASK_, _LEVEL_, _FORMAT_,...)</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/df9/torclogging_8h_source.html#l00031">torclogging.h:31</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Nov 21 2018 15:13:17 for Torc by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
